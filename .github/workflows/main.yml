name: Deploy Laravel via FTP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # --- GANTI STEP FTP LAMA DENGAN INI ---
      
      - name: ðŸ“‚ Deploy via LFTP (Robut & Auto-Retry)
        run: |
          # 1. Install LFTP
          sudo apt-get update
          sudo apt-get install -y lftp

          # 2. Jalankan Sync dengan LFTP
          # Perintah ini akan mencoba upload, dan auto-reconnect jika diputus server
          lftp -e "
            set ftp:ssl-allow no;           # Paksa FTP biasa (hindari error SSL handshake)
            set net:max-retries 3;          # Coba lagi 3x kalau gagal
            set net:timeout 60;             # Timeout toleransi
            open ${{ secrets.FTP_SERVER }}; 
            user ${{ secrets.FTP_USERNAME }} ${{ secrets.FTP_PASSWORD }}; 
            mirror -R -v \
              --parallel=2 \
              --exclude .git/ \
              --exclude .github/ \
              --exclude node_modules/ \
              --exclude tests/ \
              --exclude .env \
              --exclude .vendor \
              --exclude .env.example \
              --exclude .editorconfig \
              ./ /public_html/;             
            bye
          "
